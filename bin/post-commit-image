#!/usr/bin/env ruby
#
# Takes a picture after a commit. This
# script should be used as the `post-commit` hook.
#
# This script requires the installation of the `imagesnap` command-line tool.
#
# Example:
#
#   # Setup the hook by creating a symlink.
#   ln -s ~/bin/post-commit-image .git/hooks/post-commit
require 'socket'

MY_MACHINE = 'Oathkeeper.local'

if Socket.gethostname == MY_MACHINE
  DIRECTORY = ENV['HOME'] + '/Library/Mobile\ Documents/com~apple~CloudDocs/gitshots'
  IMAGESNAP = '/usr/local/bin/imagesnap'

  unless File.directory?(DIRECTORY)
    puts "You must create a #{DIRECTORY} directory."
    exit!(1)
  end

  unless File.exists?(IMAGESNAP)
    puts 'You must install `imagesnap`.'
    exit!(1)
  end

  file_path = "#{DIRECTORY}/#{Time.now.to_i}.jpg"

  unless File.directory?(File.expand_path('../../rebase-merge', __FILE__))
    puts "Taking capture into #{file_path}!"
    system "#{IMAGESNAP} -q -w 3 #{file_path} &"
  end
else
  system "ssh volmer@#{MY_MACHINE} /Users/volmer/.dotfiles/bin/post-commit-image"
end

exit 0
